# 主从同步
redis 为了维持高可用使用多机器部署同一份数据，当某一个实例宕机后并不会出现整体不可用的情况，此时就需要
一个详细的主从同步机制保证数据是一致的。

回过头来梳理一下，我们说的redis具有高可用的特性是指的是什么： 就是不要单点，单点永远不可以成为高可用的
程序。

## 目录
- [读写模式](###读写模式)
- [主从同步](###主从同步)
    - [第一次主从同步](####第一次主从同步)
    - [主从同步断开了咋搞](####主从同步断开了咋搞)
    - [多从如何进行复制呢](####多从如何进行复制呢)
    - [主从同步注意点](####主从同步注意点)
    
    
### 读写模式
为了避免单点服务，我们要给redis做集群，但是集群又会面临数据同步问题，数据不一致问题。那么为了避免数据不一致
引入的并发原语，redis就使用了：主写从读模式。主写了从怎么读，又如何保证从和主的数据一致，这就是我们在了解
redis的读写模式之前要记住的主线思路。
- 避免单点，需要集群
- 避免并发控制降低性能，需要主写从读
- 避免数据不一致，需要同步机制

然后很自然的就到了我们的主从同步，如何主从同步这一范畴了。其实单点加入集群就一个replicaof 127.0.0.1 6379 ，
语句就完成了我们的单点加入集群的操作，也可以成为slaveof

### 主从同步
上面已经讲到了为什么要用主写从读的模式来进行部署redis集群，目的是用多个副本保证单点故障后还能够提供稳定的服务
接下来我们聊一下主从同步的详细的细节

#### 第一次主从同步
- 从库3307 执行slaveof 127.0.0.1 6379
- 从库发送 psync ? -1 到6379
- 主库6379 响应 +FullResync {runID} {offset} 给3307
- 主库发送：RDB文件给 3307 ，3307 收到文件后清空本地的rdb文件 ,发送方式是写入replication buffer
- 主库发送： 计算master_repl_master - slave_repl_master ,写入replication buffer 

简单来梳理一下
- 从库说，我要成为你的副本
- 从库说，你要给我你当前的内存的快照
- 主库说，给你我当前的内容的总量（偏移值）和身份ID（runID），你就是我小弟了
- 主库说：这是我的内容，给你，从库此时清空本地内容然后接收内容
- 主库说: 给你我的内容的时候，我收到了一些新的内容，也给你。

正式梳理一下
- 3307 exec:  slaveof 127.0.0.1 6379 : 建立连接
- 3307 exec: psync ? -1 ：发送slave 的请求： 同步{runid}未知，的全部内容 （-1）
- 6379 exec : fullresync runid offset : fullresync 表示全量给你，也给你runid和我当前的offset
- 6379 exec :send rdb
- 6379 exec : send repl buffer 

#### 主从同步断开了咋搞
网络嘛，难免会断开，一旦断开怎么办？2.8之前一旦网络断开就直接就重新发送，耗时耗力，后面想着这样太不优雅了
我们怎么办，一般来说这时候搞增量是最优雅的，记录偏移值，重连后下发偏移值后的内容。那么偏移值的内容。

- replication buffer  : 每个链接的写入缓冲区
- repl_backlog_buffer ：备份的环形缓冲区
- slave_repl_offset : slave 的偏移值
- master_repl_offset :master的偏移值

上面存在几个概念： replication buffer 其实就是clienter buffer 和client一样，其实对于redis来说所有
连接都是一样的，副本连接我们就称为replication buffer 而已。repl_backlog_buffer，这个是一个环形缓冲区
实际上记录所有的redis的偏移值，用来计算master 和slave之间的差值进行数据同步。slave/master_repl_offset
就是环形的缓冲区的偏移值。

那么接下来逻辑就是这样了

- 主从同步断开了，网络又重新连接上了
- 3307 exec : psync runid slave_repl_offset 
- 6379 计算查找差值 master_repl_offset - slave_repl_offset 
- 6379 下发差值对应的数据,如何发送？将数据写入replication buffer 

#### 多从如何进行复制呢
一般来说不可能所有的副本都直接复制主库，因为每个都相当与一个client，而且要获取到所有的内容，所以这就很耗费主库
的性能。那么如何进行复制呢，就直接slaveof slaveip 就好了，直接形成一个主从从的模式进行数据同步。

#### 主从同步注意点
通常redis主机之间性能是不相同的，replication buffer 是可能会出现持续增长的情况的，我们可以通过设置参数限制
buffer增长： client—output-buffer-limit,如果在传输过程中从机器处理过慢，超过了这个limit设置的值，那么主机
就会杀掉这个连接，从节点就又会发起连接，反反复复容易影响业务问题，所以这点值得注意一下。