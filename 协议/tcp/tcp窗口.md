# TCP窗口
我们知道tcp 是可靠的一个通讯协议，基于它的每次收报确认，每个包收到过后都会又服务端发送一个确认包，
但是这样发送一个包，就需要一个往返时间，是不是效率太低了。

## 目录
- [小故事](###小故事)
- [MSS](###MSS)

###小故事
接下来给你讲一个小故事帮助你理解这个tcp工作原理，假如一个快递员需要送1000个 包给到某个小区用户。
但是这里面存在某个限制
- 1.菜鸟驿站只能放100个包。
- 2.快递员的小车每次只能放50个包。

在理想状态下是快递员一次性将1000个包送到菜鸟驿站，然后回复给快递站说快递送完了。但是现实我们存在很多限制
就比如上面的菜鸟驿站的容量和快递小车的容量。那么对于我们来说最好的方案是什么呢？

好了，这里面很多概念：比如菜鸟驿站就是代表的tcp 接受方的接受窗口。快递员的小车就是一次性发送多少个包，它没有
一个学术上的名称。其实网卡还是一个一个包发但不用一个一个确认，所以快递员小车容量就是只一次性最多能够发多少包
而已。

### MSS
maximum segment size ,最大报文段长度。这个是tcp建立连接的时候双方协商通讯的每一个报文所能承载的最大数据
长度。一般长度是MTU -20 -20 =1460 个长度。一般来说的话，我们窗口越大，那么一次性能够承载的数据越多。比如
说。你的mss=1460 ，此时你的窗口为2920，用上面的例子来讲的话 你一次性可以收到2个包裹。


### win 
你真的知道win代表的是什么意思吗，如何来确定一个方的发送窗口呢？你是否可以很确定的说这个字段就是发送窗口的值。
win 可以简单理解为上面的菜鸟驿站。其实我们抓的包很多人说是发送窗口，其实不是，win是指的当前我的接受窗口，而且也没有一个字段标明发送窗口是多少，发送
窗口是根据双方的接受窗口协商出来的，一般来说就是取双方最小的那个窗口。这个值win 和mss 是在三次握手的时候进行具体
协商。一般来说win的最大值是 65535 ，刚好是16bit能装下的最大值。而mss就是给win进行分包的，比如说我的win=4000，
然后协商的mss=1000，那么我单次发送的包就是4个：4000/1000 。

但是值得注意的是，一般win在实际使用过程中是会变小的，也就是发包过程中如果某个包没有确认就会一直占据着发包者的win
而不会释放。


### delay Ack
上面我们通过 win 、 mss 两个字段来确认了每次发送的包的大小和单词发送的数量，这样对每个包单次进行确认再发下一个包
这种方式来说确实是一个升级，升级点在于提升了整体发送效率，但是整体的网络包的数量还是没有减少下来。此时还有优化点在
于： 我现在发包都是多发的，那么我可不可以用一个包来确认多个包呢，依据可以通过seq是递增的，且我们可以通过seq+len
确认整个包是否有丢失。

很显然这样是行的通的，一般来说在tcp上，发送确认包只需要发送一个定时期间内的最后收到的包，如果存在中间丢包情况，也会
重发中间丢包的请求包。一般来说我们的确认包一定会小于发送的包，而且大于1/mss * 总包数量。


### 什么是滑动窗口
其实在上面我们从新梳理一下什么是窗口，为什么也称为滑动窗口，工作原理是怎么样的
- 发起方： syn ,win =2000 ,mss =1200
- 接受方： ack,syn , win=2000 ,mss=1000
- 发起方： ack ,win=2000 ,mss=1000

下面是翻译

- 客户端： 我的目前接受窗口是2000，最大的包能接受1200的大小
- 服务器： 我的接受窗口是2000，但是我只能接受1000的大小的单个包
- 客户端： 好吧，我们统一一下 ： 我们的接受窗口都是2000，但是能接受的包是1000

接下来说一下连接建立后的内容：

- 服务器： 我有一个包 16000个字节，每次装到窗口2000，分成两个包发给你。就有均分的 ABCDEFGH
- 服务器： 我第一发送给你：AB （一次性发两个包）
- 客户端： 我收到了AB了 (只回复一次)
- 服务器： 好，我接着发CD （一次性发两个包）
- 客户端： 我收到了CD (用一个包回复)

- 服务器： 我发送EF给你  （e包掉了）
- 客户端：哎，好像不太对，少了第一个包，然后回复f的确认包
- 服务器： e怎么还不回复，我滑动窗口都滑不动了，重新给你发一个
- 客户端：对了，收到了ef整个包了

- 服务器： 我发送GH 给你 （h包掉了）
- 客户端： 我收到了G包，（此时如果服务器还有包的话，那么就可以滑动一个单位和上面的情况是存在本质不同的）
- 服务器： 好，我的h包应该是掉了，再个你一个
- 客户端： 收到了完整的消息了


滑动窗口概念大概就是这样的。